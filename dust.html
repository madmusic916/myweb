<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Welcome to the Home Page!</h1>
    <p>You are successfully logged in.</p>

    <p><strong>Username:</strong> <span id="userName">Loading...</span></p>
    <p><strong>Points:</strong> <span id="userPoints">0</span></p>

    <button id="startTaskButton">Start Task</button>
    <button id="logoutButton">Logout</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // ✅ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ Get UI elements
    const userNameDisplay = document.getElementById("userName");
    const userPointsDisplay = document.getElementById("userPoints");
    const startTaskButton = document.getElementById("startTaskButton");
    const logoutButton = document.getElementById("logoutButton");

    let currentUser;

    // ✅ Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            userNameDisplay.textContent = user.displayName || "No Username";

            // ✅ Load user points when they log in
            await loadUserPoints(user.uid);

            // ✅ Check if they came from the short link
            checkReferral();
        } else {
            window.location.href = "index.html"; // Redirect if not logged in
        }
    });

    // ✅ Function to load user points from Firestore
    async function loadUserPoints(uid) {
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            userPointsDisplay.textContent = userSnap.data().rewardPoints || 0;
        } else {
            await setDoc(userRef, { rewardPoints: 0, pendingTask: false }, { merge: true });
            userPointsDisplay.textContent = 0;
        }
    }

    // ✅ Start Task Button Click
    startTaskButton.addEventListener("click", async () => {
        if (!currentUser) return;

        const sessionId = Date.now();
        console.log("Generated Session ID:", sessionId);

        // ✅ Store the task start time
        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, { pendingTask: sessionId, taskStartTime: sessionId });

        window.location.href = `https://adlink.click/st?api=7c0188129805980a4249193b317141249db63175&url=https://madmusic916.github.io/myweb/dust.html?session=${sessionId}`;
    });


    // ✅ Function to check if user came back from the short link
    // ✅ Function to check if user came back from the short link
    async function checkReferral() {
        if (!currentUser) return;

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("session");

        console.log("Extracted Session ID from URL:", sessionId);
        console.log("Referrer:", document.referrer);

        const userRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) return;

        const storedSession = userSnap.data().pendingTask;
        const taskStartTime = userSnap.data().taskStartTime || 0;
        const lastCompletedTask = userSnap.data().lastCompletedTask || 0;
        const timeElapsed = Date.now() - taskStartTime;

        console.log("Stored Session:", storedSession);
        console.log("Time elapsed since task started:", timeElapsed);

        // ✅ Prevent quick return (less than 10 seconds)
        if (timeElapsed < 10000) {
            alert("You must complete the short link properly!");
            return;
        }

        // ✅ Ensure user came from short link (but handle browser referrer blocking)
        if (!document.referrer.includes("adlink.click")) {
            alert("Warning: We couldn’t verify if you completed the short link. If this is a mistake, make sure your browser allows referrer tracking.");
            return;
        }

        // ✅ Prevent reusing old session IDs for multiple rewards
        if (Number(sessionId) === lastCompletedTask) {
            alert("You already completed this task! Start a new task to earn more points.");
            return;
        }

        // ✅ Check if the session ID matches the pending task
        if (Number(sessionId) === storedSession) {
            // ✅ Award points since the user completed the short link
            const newPoints = (userSnap.data().rewardPoints || 0) + 10;

            // ✅ Update Firestore: Give points, reset pending task, clear task time & store last completed task
            await updateDoc(userRef, {
                rewardPoints: newPoints,
                pendingTask: false,
                taskStartTime: null,
                lastCompletedTask: Number(sessionId) // Store last completed session
            });

            userPointsDisplay.textContent = newPoints; // Update UI
           
        } else {
            alert("Invalid session ID! Complete the task properly.");
        }
    }


    // ✅ Handle Logout
    logoutButton.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
    });

</script>

</body>
</html>
