<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        .container {
            padding: 20px;
        }
        button {
            padding: 10px;
            margin: 10px;
            cursor: pointer;
        }
        button:disabled {
            background-color: gray;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Welcome to the Home Page!</h1>
    <p>You are successfully logged in.</p>

    <p><strong>Username:</strong> <span id="userName">Loading...</span></p>
    <p><strong>Points:</strong> <span id="userPoints">0</span></p>

    <!-- Task buttons -->
    <button id="taskButton1">Task 1</button>
    <button id="taskButton2">Task 2</button>
    <button id="taskButton3">Task 3</button>
    <button id="taskButton4">Task 4</button>
    <button id="taskButton5">Task 5</button>

    <button id="logoutButton">Logout</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // ✅ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ Get UI elements
    const userNameDisplay = document.getElementById("userName");
    const userPointsDisplay = document.getElementById("userPoints");
    const logoutButton = document.getElementById("logoutButton");

    // ✅ Task buttons mapping
    const buttons = {
        button1: "taskButton1",
        button2: "taskButton2",
        button3: "taskButton3",
        button4: "taskButton4",
        button5: "taskButton5"
    };

    let currentUser;

    // ✅ Authentication check
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            userNameDisplay.textContent = user.displayName || "No Username";

            // ✅ Load user data
            await loadUserData();
            checkReferral();
        } else {
            window.location.href = "index.html"; // Redirect if not logged in
        }
    });

    // ✅ Load user data from Firestore
    async function loadUserData() {
        if (!currentUser) return;

        const userRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) {
            await setDoc(userRef, {
                rewardPoints: 0,
                taskStatus: {},
                shortLinks: {
                    button1: "https://adlink.click/st?api=123",
                    button2: "https://adlink.click/st?api=456",
                    button3: "https://adlink.click/st?api=789",
                    button4: "https://adlink.click/st?api=101",
                    button5: "https://adlink.click/st?api=202"
                }
            }, { merge: true });
        }

        const data = userSnap.data();
        userPointsDisplay.textContent = data.rewardPoints || 0;
        updateButtons(data.taskStatus, data.shortLinks);
    }

    // ✅ Update button states based on Firestore data
    function updateButtons(taskStatus, shortLinks) {
        Object.keys(buttons).forEach(buttonId => {
            const button = document.getElementById(buttons[buttonId]);
            const task = taskStatus[buttonId] || {};
            const now = Date.now();

            if (task.completed && task.expiresAt > now) {
                button.disabled = true; // Disable until 24h passes
                button.dataset.url = "";
            } else {
                button.disabled = false; // Enable task button
                button.dataset.url = shortLinks[buttonId] || "";
                button.onclick = () => startTask(buttonId);
            }
        });
    }

    // ✅ Start a task (when user clicks a button)
    async function startTask(buttonId) {
        if (!currentUser) return;

        const button = document.getElementById(buttons[buttonId]);
        const shortLink = button.dataset.url;

        if (!shortLink) {
            alert("No available task for this button.");
            return;
        }

        const userRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userRef);
        const taskStatus = userSnap.data().taskStatus || {};

        if (taskStatus[buttonId]?.completed) {
            alert("You already completed this task. Wait 24 hours.");
            return;
        }

        // ✅ Generate session ID
        const sessionId = Date.now();

        // ✅ Update Firestore with task start time
        await updateDoc(userRef, {
            [`taskStatus.${buttonId}`]: { completed: false, expiresAt: null, taskStartTime: sessionId },
            pendingTask: sessionId
        });

        // ✅ Redirect to short link
        window.location.href = `${shortLink}?session=${sessionId}`;
    }

    // ✅ Check referral completion
    async function checkReferral() {
        if (!currentUser) return;

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("session");

        const userRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userRef);

        if (!userSnap.exists()) return;

        const taskStatus = userSnap.data().taskStatus || {};
        const storedSession = userSnap.data().pendingTask;
        const timeElapsed = Date.now() - storedSession;

        if (timeElapsed < 10000) {
            alert("You must complete the short link properly!");
            return;
        }

        Object.keys(buttons).forEach(async (buttonId) => {
            if (taskStatus[buttonId]?.completed) return;

            await updateDoc(userRef, {
                [`taskStatus.${buttonId}`]: { completed: true, expiresAt: Date.now() + 86400000, taskStartTime: null },
                [`shortLinks.${buttonId}`]: ""
            });

            document.getElementById(buttons[buttonId]).disabled = true;
            document.getElementById(buttons[buttonId]).dataset.url = "";
        });

        location.reload();
    }

    // ✅ Logout handler
    logoutButton.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
    });

</script>

</body>
</html>
