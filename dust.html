<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
        .container {
            display: none; /* Hide content until data is loaded */
            margin-top: 50px;
        }
        .task-button {
            display: block;
            margin: 10px auto;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
        }
        .disabled {
            background-color: grey;
            cursor: not-allowed;
        }
        #loading {
            font-size: 20px;
            font-weight: bold;
            margin-top: 100px;
        }
    </style>
</head>
<body>

<!-- Preloader -->
<div id="loading">Loading...</div>

<!-- Main Content -->
<div class="container" id="mainContent">
    <h1>Welcome to the Home Page!</h1>
    <p>You are successfully logged in.</p>

    <p><strong>Username:</strong> <span id="userName">Loading...</span></p>
    <p><strong>Points:</strong> <span id="userPoints">0</span></p>

    <div id="taskButtons">
        <button class="task-button" data-task="1">Task 1</button>
        <button class="task-button" data-task="2">Task 2</button>
        <button class="task-button" data-task="3">Task 3</button>
        <button class="task-button" data-task="4">Task 4</button>
        <button class="task-button" data-task="5">Task 5</button>
    </div>

    <button id="logoutButton">Logout</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // ✅ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ Get UI elements
    const userNameDisplay = document.getElementById("userName");
    const userPointsDisplay = document.getElementById("userPoints");
    const taskButtons = document.querySelectorAll(".task-button");
    const logoutButton = document.getElementById("logoutButton");
    const loadingScreen = document.getElementById("loading");
    const mainContent = document.getElementById("mainContent");
    let currentUser;

    // ✅ Load all user data at once
    async function loadUserData(uid) {
        const userRef = doc(db, "users", uid);

        try {
            const userSnap = await getDoc(userRef);
            if (userSnap.exists()) {
                const userData = userSnap.data();

                userNameDisplay.textContent = currentUser.displayName || "No Username";
                userPointsDisplay.textContent = userData.rewardPoints || 0;

                const completedTasks = userData.completedTasks || [];
                const taskCompletionTimes = userData.taskCompletionTimes || {}; // ✅ Get stored timestamps
                const now = Date.now();

                taskButtons.forEach(button => {
                    const taskId = button.getAttribute("data-task");
                    const lastCompletedTime = taskCompletionTimes[taskId] || 0;

                    if (completedTasks.includes(taskId) && now - lastCompletedTime < 24 * 60 * 60 * 1000) {
                        // ✅ Disable button if 24 hours haven't passed
                        button.disabled = true;
                        button.classList.add("disabled");
                    } else {
                        // ✅ Enable button if 24 hours have passed
                        button.disabled = false;
                        button.classList.remove("disabled");
                        button.addEventListener("click", () => startTask(taskId));
                    }
                });

            } else {
                await setDoc(userRef, { rewardPoints: 0, completedTasks: [] }, { merge: true });
                userNameDisplay.textContent = currentUser.displayName || "No Username";
                userPointsDisplay.textContent = 0;
            }
        } catch (error) {
            console.error("Error loading user data:", error);
        }
    }



    // ✅ Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            await loadUserData(user.uid);
            // ✅ Hide loading screen and show main content
            loadingScreen.style.display = "none";
            mainContent.style.display = "block";
            checkReferral();
        } else {
            window.location.href = "index.html"; // Redirect if not logged in
        }
    });

    // ✅ Securely Load User Data & Disable Completed Tasks
   /*/ async function loadUserData(uid) {
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            userPointsDisplay.textContent = userSnap.data().rewardPoints || 0;

            // ✅ Get completed tasks from Firestore
            const completedTasks = userSnap.data().completedTasks || [];

            // ✅ Securely disable completed buttons
            taskButtons.forEach(button => {
                const taskId = button.getAttribute("data-task");
                if (completedTasks.includes(taskId)) {
                    button.disabled = true;
                    button.classList.add("disabled");
                } else {
                    button.addEventListener("click", () => startTask(taskId));
                }
            });
        } else {
            await setDoc(userRef, { rewardPoints: 0, completedTasks: [] }, { merge: true });
            userPointsDisplay.textContent = 0;
        }
    }/*/

    // ✅ Start Task Function (Redirect to Short Link)
    async function startTask(taskId) {
        if (!currentUser) return;

        const sessionId = Date.now();
        console.log(`Starting Task ${taskId} - Session ID:`, sessionId);

        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, { pendingTask: sessionId, taskStartTime: sessionId });

        window.location.href = `https://adlink.click/st?api=7c0188129805980a4249193b317141249db63175&url=https://madmusic916.github.io/myweb/dust.html?session=${sessionId}&task=${taskId}`;
    }

    // ✅ Check if User Returned from Short Link
    async function checkReferral() {
        if (!currentUser) return;

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("session");
        const taskId = urlParams.get("task");

        if (!sessionId || !taskId) return;

        const userRef = doc(db, "users", currentUser.uid);
        const userSnap = await getDoc(userRef);
        if (!userSnap.exists()) return;

        const storedSession = userSnap.data().pendingTask;
        const taskStartTime = userSnap.data().taskStartTime || 0;
        const lastCompletedTask = userSnap.data().lastCompletedTask || 0;
        const completedTasks = userSnap.data().completedTasks || [];
        const timeElapsed = Date.now() - taskStartTime;

        if (timeElapsed < 10000) {
            alert("You must complete the short link properly!");
            return;
        }

        if (!document.referrer.includes("adlink.click")) {
            alert("Warning: We couldn’t verify if you completed the short link.");
            return;
        }

        if (Number(sessionId) === lastCompletedTask || completedTasks.includes(taskId)) {
            alert("You already completed this task!");
            return;
        }

        if (Number(sessionId) === storedSession) {
            const newPoints = (userSnap.data().rewardPoints || 0) + 10;
            completedTasks.push(taskId);

            await updateDoc(userRef, {
                rewardPoints: newPoints,
                pendingTask: false,
                taskStartTime: null,
                lastCompletedTask: Number(sessionId),
                completedTasks: completedTasks,
                [`taskCompletionTimes.${taskId}`]: Date.now() // ✅ Store task completion time
            });

            userPointsDisplay.textContent = newPoints;
            taskButtons.forEach(button => {
                if (button.getAttribute("data-task") === taskId) {
                    button.disabled = true;
                    button.classList.add("disabled");
                }
            });
        }
        else {
            alert("Invalid session ID!");
        }
    }

    // ✅ Handle Logout
    logoutButton.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
    });

</script>

</body>
</html>
