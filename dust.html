<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin: 0;
            padding: 0;
            background-color: #f4f4f9;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Welcome to the Home Page!</h1>
    <p>You are successfully logged in.</p>

    <p><strong>Username:</strong> <span id="userName">Loading...</span></p>
    <p><strong>Points:</strong> <span id="userPoints">0</span></p>

    <button id="startTaskButton">Start Task</button>
    <button id="logoutButton">Logout</button>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/9.21.0/firebase-firestore.js";
    import { firebaseConfig } from "./firebaseConfig.js";

    // ✅ Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ✅ Get UI elements
    const userNameDisplay = document.getElementById("userName");
    const userPointsDisplay = document.getElementById("userPoints");
    const startTaskButton = document.getElementById("startTaskButton");
    const logoutButton = document.getElementById("logoutButton");

    let currentUser;

    // ✅ Check authentication state
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            currentUser = user;
            userNameDisplay.textContent = user.displayName || "No Username";

            // ✅ Load user points when they log in
            await loadUserPoints(user.uid);

            // ✅ Check if they came from the short link
            checkReferral();
        } else {
            window.location.href = "index.html"; // Redirect if not logged in
        }
    });

    // ✅ Function to load user points from Firestore
    async function loadUserPoints(uid) {
        const userRef = doc(db, "users", uid);
        const userSnap = await getDoc(userRef);

        if (userSnap.exists()) {
            userPointsDisplay.textContent = userSnap.data().rewardPoints || 0;
        } else {
            await setDoc(userRef, { rewardPoints: 0, pendingTask: false }, { merge: true });
            userPointsDisplay.textContent = 0;
        }
    }

    // ✅ Start Task Button Click
    startTaskButton.addEventListener("click", async () => {
        if (!currentUser) return;

        // ✅ Generate a unique session ID (timestamp-based)
        const sessionId = Date.now();
        console.log("Generated Session ID:", sessionId);

        // ✅ Set task as "pending" in Firestore
        const userRef = doc(db, "users", currentUser.uid);
        await updateDoc(userRef, { pendingTask: sessionId });
        console.log("Stored in Firestore:", sessionId);

        // ✅ Redirect to the short link with session ID
        window.location.href = `https://adlink.click/st?api=7c0188129805980a4249193b317141249db63175&url=https://madmusic916.github.io/myweb/dust.html?session=${sessionId}`;
    });

    // ✅ Function to check if user came back from the short link
    async function checkReferral() {
        if (!currentUser) return;

        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get("session");

        console.log("Extracted Session ID from URL:", sessionId);

        if (sessionId) {
            const userRef = doc(db, "users", currentUser.uid);
            const userSnap = await getDoc(userRef);

            if (userSnap.exists()) {
                const storedSession = userSnap.data().pendingTask;
                console.log("Stored Pending Task in Firestore:", storedSession);

                // ✅ Convert session ID to number before comparing
                if (Number(sessionId) === storedSession) {
                    // ✅ Award points since the user completed the short link
                    const newPoints = (userSnap.data().rewardPoints || 0) + 10; // Reward 10 points
                    await updateDoc(userRef, { rewardPoints: newPoints, pendingTask: false });

                    userPointsDisplay.textContent = newPoints; // Update UI
                   
                } else {
                    alert("You must complete the short link task first!");
                }
            }
        }
    }

    // ✅ Handle Logout
    logoutButton.addEventListener("click", async () => {
        await signOut(auth);
        window.location.href = "index.html";
    });

</script>

</body>
</html>
